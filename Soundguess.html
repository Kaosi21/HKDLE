<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Sound Guess - Hollow Knight</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      background-image: url("img/Sfondo.jpeg");
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center;
    }
    .custom-audio-player {
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid #fff;
  border-radius: 16px;
  padding: 24px;
  width: 320px;
  margin: 0 auto 30px;
  box-shadow: 0 8px 18px rgba(255,255,255,0.1);
  transition: transform 0.3s ease;
}

.custom-audio-player:hover {
  transform: scale(1.02);
}

.audio-box {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.audio-button {
  background: none;
  border: 2px solid #fff;
  color: #fff;
  font-size: 20px;
  cursor: pointer;
  padding: 12px 18px;
  border-radius: 30px;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 10px rgba(255,255,255,0.1);
}

.audio-button:hover {
  background-color: #fff;
  color: #000;
  transform: translateY(-2px);
}

#audio-label {
  text-decoration: underline;
}

#volume-slider {
  width: 100%;
  height: 6px;
  margin-top: 12px;
  background: #444;
  border-radius: 10px;
  appearance: none;
  cursor: pointer;
}

#volume-slider::-webkit-slider-thumb {
  appearance: none;
  width: 35px;
  height: 35px;
  background-image: url('img/Macchia.webp');
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  border: none;
  margin-top: -15px;
  cursor: pointer;
}

#volume-slider::-moz-range-thumb {
  width: 24px;
  height: 24px;
  background-image: url('img/Macchia.webp');
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  border: none;
  cursor: pointer;
}

#volume-slider::-webkit-slider-runnable-track {
  background: #888;
  height: 6px;
  border-radius: 10px;
}
  </style>
</head>
<body>

<h1>Guess the Sound - Hollow Knight</h1>

<div class="custom-audio-player">
  <div class="audio-box">
    <button id="custom-audio-toggle" onclick="toggleAudio()" class="audio-button">
      ▶️ <span id="audio-label">Play audio</span>
    </button>
    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1" />
  </div>
  <audio id="audio" preload="auto"></audio>
</div>

<div class="autocomplete-wrapper">
  <input
    type="text"
    id="guess"
    placeholder="Type the name..."
    oninput="showSuggestions()"
    autocomplete="off"
  />
  <div id="suggestions" class="suggestions-list"></div>
</div>

<div style="text-align:center;">
  <button onclick="checkGuess()">Submit</button>
</div>

<table id="feedback">
  <thead>
    <tr>
      <th>Image</th>
      <th>Name</th>
      <th>Location</th>
      <th>Type</th>
      <th>Difficulty</th>
      <th>Theme</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="win-screen">
  <h2>Hai indovinato!</h2>
  <h2>Il suono era:</h2>
  <img id="win-image" class="winner-img" src="" alt="Winner" />
  <button onclick="location.reload()">Gioca di nuovo</button>
</div>

<script>
  let sounds = [];
  let target = null;
  let tentativi = 0;
  const usedSounds = [];

  function toggleAudio() {
    const audio = document.getElementById("audio");
    const label = document.getElementById("audio-label");
    const button = document.getElementById("custom-audio-toggle");

    if (audio.paused) {
      audio.play();
      label.textContent = "Pause audio";
      button.innerHTML = "⏸️ <span id='audio-label'>Pause audio</span>";
    } else {
      audio.pause();
      label.textContent = "Play audio";
      button.innerHTML = "▶️ <span id='audio-label'>Play audio</span>";
    }

    audio.addEventListener("ended", () => {
      label.textContent = "Play audio";
      button.innerHTML = "▶️ <span id='audio-label'>Play audio</span>";
    });

    audio.addEventListener("timeupdate", () => {
      if (audio.currentTime >= 8) {
        audio.pause();
        audio.currentTime = 0;
        label.textContent = "Play audio";
        button.innerHTML = "▶️ <span id='audio-label'>Play audio</span>";
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const audio = document.getElementById("audio");
    const volumeSlider = document.getElementById("volume-slider");

    fetch("sound.json")
      .then((res) => res.json())
      .then((data) => {
        sounds = data;
        target = sounds[Math.floor(Math.random() * sounds.length)];
        audio.src = target.File;
        audio.currentTime = 0;
      });

    volumeSlider.addEventListener("input", () => {
      audio.volume = volumeSlider.value;
    });
  });

  function showSuggestions() {
    const input = document.getElementById("guess").value.toLowerCase();
    const suggestionsDiv = document.getElementById("suggestions");
    suggestionsDiv.innerHTML = "";

    if (input.length === 0) {
      suggestionsDiv.style.display = "none";
      return;
    }

    const filtered = sounds
      .filter((s) => !usedSounds.includes(s.Name.toLowerCase()))
      .filter((s) => s.Name.toLowerCase().startsWith(input));

    filtered.forEach((sound) => {
      const item = document.createElement("div");
      item.className = "suggestion-item";
      item.innerHTML = `
        <img src="${sound.Photo}" alt="${sound.Name}" onerror="this.src='img/default.png'">
        <span>${sound.Name}</span>`;
      item.onclick = () => {
        document.getElementById("guess").value = sound.Name;
        suggestionsDiv.innerHTML = "";
        suggestionsDiv.style.display = "none";
      };
      suggestionsDiv.appendChild(item);
    });

    suggestionsDiv.style.display = filtered.length > 0 ? "block" : "none";
  }

  function getClass(guessVal, targetVal) {
    const normalize = str => str.toLowerCase().split(",").map(s => s.trim());
    const guessList = normalize(guessVal);
    const targetList = normalize(targetVal);
    const intersection = guessList.filter(val => targetList.includes(val));

    if (guessList.length === targetList.length && intersection.length === guessList.length) {
      return "match";
    } else if (intersection.length > 0) {
      return "partial";
    } else {
      return "wrong";
    }
  }

  function checkGuess() {
    const input = document.getElementById("guess").value.toLowerCase();
    const guessed = sounds.find(s => s.Name.toLowerCase() === input);

    if (!guessed) {
      alert("Elemento non trovato!");
      return;
    }

    if (usedSounds.includes(guessed.Name.toLowerCase())) {
      alert("Hai già provato questo nome!");
      return;
    }

    usedSounds.push(guessed.Name.toLowerCase());
    tentativi++;

    const feedbackBody = document.querySelector("#feedback tbody");
    const row = document.createElement("tr");
    row.classList.add("fade-slide-row");

    row.innerHTML = `
      <td><img class="character-img" src="${guessed.Photo}" alt="${guessed.Name}" onerror="this.src='img/default.png'"></td>
      <td class="${getClass(guessed.Name, target.Name)}">${guessed.Name}</td>
      <td class="${getClass(guessed.Location, target.Location)}">${guessed.Location}</td>
      <td class="${getClass(guessed.Type, target.Type)}">${guessed.Type}</td>
      <td class="${getClass(guessed.Difficulty, target.Difficulty)}">${guessed.Difficulty}</td>
      <td class="${getClass(guessed.Themename, target.Themename)}">${guessed.Themename}</td>
    `;

    feedbackBody.appendChild(row);

    if (guessed.Name.toLowerCase() === target.Name.toLowerCase()) {
      document.getElementById("win-screen").classList.add("active");
      document.getElementById("win-image").src = guessed.Photo;
      createParticles();
    }

    document.getElementById("guess").value = "";
  }

  function createParticles() {
    const colors = ["#ff4757", "#1e90ff", "#2ed573", "#ffa502", "#eccc68"];
    const numParticles = 80;

    for (let i = 0; i < numParticles; i++) {
      const particle = document.createElement("div");
      particle.classList.add("particle");
      particle.style.background = colors[Math.floor(Math.random() * colors.length)];

      const x = (Math.random() - 0.5) * 300 + "px";
      const y = (Math.random() - 0.5) * 300 + "px";
      particle.style.setProperty("--x", x);
      particle.style.setProperty("--y", y);

      particle.style.left = "50%";
      particle.style.top = "50%";

      document.body.appendChild(particle);

      setTimeout(() => {
        particle.remove();
      }, 1000);
    }
  }

  document.getElementById("guess").addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
      event.preventDefault();
      checkGuess();
    }
  });
</script>

</body>
</html>
